{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reserva de Cortes - Blessed Barbershop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/reserva.css' %}" />
  <link rel="icon" href="https://png.pngtree.com/png-vector/20220818/ourmid/pngtree-barbershop-pole-decoration-png-image_6115703.png" type="image/png">

</head>
<body>

<nav>
  <h2>Categor√≠as</h2>
  <!-- Mostrar 'Todos' para ver todos los cortes -->
  <a href="{% url 'reservas' %}" class="{% if categoria_actual == 'todos' or not categoria_actual %}active{% endif %}">Todos</a>
  {% for clave, nombre in categorias %}
    <a href="?categoria={{ clave }}" class="{% if categoria_actual == clave %}active{% endif %}">{{ nombre }}</a>
  {% endfor %}

  <a href="{% url 'mis_reservas' %}" class="btn btn-dark">Mis Reservas</a>
  <a href="{% url 'index' %}" class="btn btn-dark">Volver</a>
</nav>

<main>
  <h1>Cortes de {{ titulo_categoria }}</h1>
  
  <div class="row g-4">
    {% for corte in cortes %}
      <div class="col-md-6 col-lg-4">
        <div class="card h-100 p-3">
          <div class="card-body d-flex flex-column">
            <i class="bi {{ corte.icon|default:'bi-scissors' }} text-center fs-1 mb-3"></i>
            <h5 class="card-title">{{ corte.titulo }}</h5>
            <p class="card-text"><small>{{ corte.duracion }} min ‚Ä¢ ${{ corte.precio }}</small></p>
            <p class="card-text flex-fill">{{ corte.descripcion }}</p>
            <button class="btn btn-dark mt-2" onclick="abrirReserva({{ corte.id }}, {{ corte.duracion }})">Agendar servicio</button>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No hay cortes disponibles en esta categor√≠a.</p>
    {% endfor %}
  </div>
</main>

<script>
  let corteSeleccionado = null;
  let duracionCorte = 0;

  function abrirReserva(id, duracion) {
    corteSeleccionado = id;
    duracionCorte = duracion;
    document.getElementById('inputCorteId').value = id;
    document.getElementById('modalReserva').style.display = 'flex';

    const fechaInput = document.getElementById('fecha');
    const hoy = new Date().toISOString().split('T')[0];
    fechaInput.setAttribute('min', hoy); // üîí bloquear fechas pasadas
    fechaInput.value = '';

    document.getElementById('hora_inicio').innerHTML = '<option value="">Seleccione una hora</option>';
  }

  function cerrarModal() {
    document.getElementById('modalReserva').style.display = 'none';
  }

  function cargarHoras() {
    const fecha = document.getElementById('fecha').value;
    const barbero = document.getElementById('barbero').value;
    const horaSelect = document.getElementById('hora_inicio');

    if (!fecha || !corteSeleccionado || !barbero) {
      horaSelect.innerHTML = '<option value="">Seleccione corte, barbero y fecha</option>';
      return;
    }

    horaSelect.innerHTML = '<option>Cargando...</option>';

    fetch(`/api/horas-disponibles/?corte=${corteSeleccionado}&fecha=${fecha}&barbero=${barbero}`)
      .then(res => res.json())
      .then(data => {
        horaSelect.innerHTML = '';

        const ahora = new Date();
        const hoy = ahora.toISOString().split('T')[0];
        const horaActual = ahora.getHours().toString().padStart(2, '0') + ":" + ahora.getMinutes().toString().padStart(2, '0');

        const esHoy = (fecha === hoy);

        const horasFiltradas = esHoy
          ? data.filter(h => h > horaActual)  // üîí solo horas futuras si es hoy
          : data;

        if (horasFiltradas.length > 0) {
          horasFiltradas.forEach(hora => {
            const option = document.createElement('option');
            option.value = hora;
            option.textContent = hora;
            horaSelect.appendChild(option);
          });
        } else {
          horaSelect.innerHTML = '<option value="">No hay horas disponibles</option>';
        }
      });
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('fecha').addEventListener('change', cargarHoras);
    document.getElementById('barbero').addEventListener('change', cargarHoras);
  });

  document.addEventListener('DOMContentLoaded', function () {
    const toastElList = Array.from(document.querySelectorAll('.toast'));
    toastElList.forEach(function (toastEl) {
      const toast = new bootstrap.Toast(toastEl, {
        autohide: true,
        delay: 2000  // 2 segundos
      });
      toast.show();
    });
  });
</script>






<!-- Modal de Reserva -->
<div id="modalReserva" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background-color: rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:white; padding:30px; border-radius:10px; max-width:500px; width:100%; position:relative;">
    <span style="position:absolute; top:10px; right:15px; cursor:pointer; font-size: 30px; color: black;" onclick="cerrarModal()">&times;</span>
    <h2>Reservar Servicio</h2>
    <form id="formReserva" method="POST" action="{% url 'reservas' %}">
      {% csrf_token %}
      <input type="hidden" name="corte" id="inputCorteId">

      <div class="mb-3">
        <label for="barbero">Barbero:</label>
        <select name="barbero" id="barbero" class="form-control" required>
          <option value="">Seleccione un barbero</option>
          {% for barbero in barberos %}
            {% if barbero.disponible %}
               <option value="{{ barbero.id }}">{{ barbero.nombre }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label for="fecha">Fecha:</label>
        <input type="date" name="fecha" id="fecha" class="form-control" required onchange="cargarHoras()">
      </div>

      <div class="mb-3">
        <label for="hora_inicio">Hora disponible:</label>
        <select name="hora_inicio" id="hora_inicio" class="form-control" required>
          <option value="">Seleccione una hora</option>
        </select>
      </div>

      <button type="submit" class="btn btn-dark">Confirmar Reserva</button>
    </form>
  </div>
</div>


<div class="position-fixed top-50 start-50 translate-middle p-3" style="z-index: 1100;">
  {% for message in messages %}
    <div class="toast align-items-center text-dark bg-{{ message.tags }} border-0 show shadow-lg fs-5 px-4 py-3" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 500px; max-width: 90%; background-color: gray;">
      <div class="d-flex align-items-center">
       <div class="toast-body w-100">
  {% if message.tags == "success" %}‚úÖ{% elif message.tags == "warning" %}‚ö†Ô∏è{% elif message.tags == "danger" %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
  {{ message }}
</div>
        <button type="button" class="btn-close btn-close-white ms-3" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
    </div>
  {% endfor %}
</div>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js" integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D" crossorigin="anonymous"></script>

</body>
</html>
